<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>满赠计算器</title>
  <style>
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      margin: 0;
      padding: 40px;
      background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
      min-height: 100vh;
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(33, 150, 243, 0.2);
      padding: 40px;
      position: relative;
      border: 1px solid #e1f5fe;
    }
    
    .back-btn { 
      position: absolute;
      top: 20px;
      left: 20px;
      padding: 12px 20px;
      font-size: 18px;
      background: #42a5f5;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(66, 165, 245, 0.4);
    }
    
    .back-btn:hover {
      background: #1e88e5;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(66, 165, 245, 0.6);
    }
    
    h1 {
      text-align: center;
      color: #1565c0;
      margin-bottom: 30px;
      font-size: 2.2em;
      text-shadow: 0 2px 4px rgba(21, 101, 192, 0.1);
    }
    
    .input-section {
      margin-bottom: 25px;
    }
    
    .input-row { 
      margin: 15px 0; 
      padding: 15px;
      background: #f8fbff;
      border-radius: 8px;
      border-left: 4px solid #42a5f5;
      transition: all 0.3s ease;
    }
    
    .input-row:hover {
      background: #e3f2fd;
      transform: translateX(5px);
    }
    
    label { 
      font-weight: 600;
      color: #1976d2;
      margin-right: 10px;
    }
    
    input { 
      padding: 10px 12px;
      margin: 0 10px;
      border: 2px solid #e1f5fe;
      border-radius: 6px;
      font-size: 14px;
      transition: all 0.3s ease;
    }
    
    input:focus {
      outline: none;
      border-color: #42a5f5;
      box-shadow: 0 0 0 3px rgba(66, 165, 245, 0.1);
    }
    
    .parameters {
      background: #f8fbff;
      padding: 20px;
      border-radius: 10px;
      margin: 25px 0;
      border-left: 4px solid #ba68c8;
    }
    
    .parameters label {
      color: #6a1b9a;
    }
    
    .parameters input {
      border-color: #e1bee7;
    }
    
    .parameters input:focus {
      border-color: #ba68c8;
      box-shadow: 0 0 0 3px rgba(186, 104, 200, 0.1);
    }
    
    button[type="button"] { 
      padding: 15px 30px; 
      font-size: 18px; 
      margin-top: 20px;
      background: linear-gradient(135deg, #42a5f5, #1976d2);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(66, 165, 245, 0.4);
      font-weight: 600;
      width: 100%;
    }
    
    button[type="button"]:hover {
      background: linear-gradient(135deg, #1e88e5, #1565c0);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(66, 165, 245, 0.6);
    }
    
    .error { 
      color: #d32f2f; 
      font-weight: bold; 
      margin-top: 15px;
      padding: 15px;
      background: #ffebee;
      border-radius: 8px;
      border-left: 4px solid #f44336;
      text-align: center;
    }
    
    .input-group {
      display: inline-block;
      margin: 0 15px;
    }
    
    .section-title {
      color: #1565c0;
      font-size: 1.1em;
      font-weight: 600;
      margin-bottom: 15px;
      padding-bottom: 5px;
      border-bottom: 2px solid #e3f2fd;
    }
  </style>
</head>
<body>
  <div class="container">
    <button class="back-btn" onclick="history.back()">⬅ 返回</button>
    <h1>第二步: 请输入谷子单价和最少买多少个</h1>
    
    <div class="section-title">谷子单价和最低数量</div>
    <form id="inputForm"></form>

    <div class="parameters">
      <div class="section-title" style="color: #6a1b9a;">第三步：请输入计算参数</div>
      <div class="input-row">
        <div class="input-group">
          <label>目标总价: </label>
          <input type="number" id="target" min="1" placeholder="比如188">
        </div>
        <div class="input-group">
          <label>总价可以超出: </label>
          <input type="number" id="errt" value="0" min="0">
        </div>
      </div>
    </div>

    <button type="button" onclick="calculate()">计算满赠方案</button>
    <div id="errorMsg" class="error"></div>
  </div>

  <script>
    const num_prices = parseInt(localStorage.getItem("num_prices"));
    const form = document.getElementById("inputForm");

    for (let i = 0; i < num_prices; i++) {
      const div = document.createElement("div");
      div.classList.add("input-row");
      div.innerHTML = `
        <div class="input-group">
          <label>价格 ${i+1}: </label>
          <input type="number" step="any" id="price${i}" required>
        </div>
        <div class="input-group">
          <label>最少: </label>
          <input type="number" id="min_item${i}" value="0" min="0" required>
        </div>
      `;
      form.appendChild(div);
    }

    function calculate() {
      const prices = [], min_items = [];
      for (let i = 0; i < num_prices; i++) {
        const p = parseFloat(document.getElementById(`price${i}`).value);
        const m = parseInt(document.getElementById(`min_item${i}`).value);
        if (isNaN(p) || p <= 0 || isNaN(m) || m < 0) {
          document.getElementById("errorMsg").textContent = "请输入大于0的价格和不小于0的最低数量。";
          return;
        }
        prices.push(p);
        min_items.push(m);
      }

      const target = parseFloat(document.getElementById("target").value);
      const errt = parseFloat(document.getElementById("errt").value) || 0;

      if (isNaN(target) || target <= 0) {
        document.getElementById("errorMsg").textContent = "请输入大于0的目标总价。";
        return;
      }

      // Check distinct prices
      const distinct = new Set(prices).size === prices.length;
      if (!distinct) {
        document.getElementById("errorMsg").textContent = "Prices must be distinct.";
        return;
      }

      const baseDot = prices.reduce((sum, p, i) => sum + p * min_items[i], 0);
      const line = target - baseDot;

      if (line < 0) {
        document.getElementById("errorMsg").textContent = "你的最低数量对应价格已经超过了目标总价，请增加目标总价。";
        return;
      }

      // Sort descending by price
      const combined = prices.map((p, i) => ({ price: p, min: min_items[i] }))
                             .sort((a, b) => b.price - a.price);
      const prar = combined.map(obj => obj.price);
      const minSorted = combined.map(obj => obj.min);
 
      console.log("Prices entered:", prices);
      console.log("Min items:", min_items);
      console.log("Target:", target);
      console.log("Computed line =", line);
      localStorage.setItem("prar", JSON.stringify(prar));
      localStorage.setItem("min_items", JSON.stringify(minSorted));
      localStorage.setItem("errt", errt);
      localStorage.setItem("line", line);
      localStorage.setItem("target", target);

      window.location.href = "results.html";
    }
  </script>
</body>
</html>