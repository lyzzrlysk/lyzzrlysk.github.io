<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ‹†å¤šç§å•è®¡ç®—å™¨</title>
  <link rel="stylesheet" href="style.css">
  <style>
    /* Unique styles for the Gamma Layout */
    .scheme-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }
    .scheme-card {
      background: var(--row-bg);
      padding: 20px;
      border-radius: 16px;
      cursor: pointer;
      box-shadow: var(--shadow-card);
      border: 2px solid transparent;
      transition: all 0.2s;
    }
    .scheme-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-soft);
    }
    .scheme-card.active {
      border-color: var(--primary-color);
      background: var(--info-bg);
    }
    .scheme-name {
      font-weight: 700;
      color: var(--primary-color);
      margin-bottom: 8px;
    }
    .scheme-stat {
      font-size: 0.9rem;
      color: var(--text-color);
      margin-bottom: 4px;
    }
    .res-tag { 
      background: rgba(140, 158, 255, 0.1); 
      padding: 4px 10px; 
      border-radius: 8px; 
      font-size: 0.9rem; 
      color: var(--text-color);
      border: 1px solid rgba(140, 158, 255, 0.2);
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Circular Home Button -->
    <a href="index.html" class="btn-home" aria-label="Home">ğŸ </a>
    
    <button class="theme-toggle" onclick="toggleTheme()" id="themeBtn">ğŸŒ™</button>

    <h1>æ‹†å¤šç§å•è®¡ç®—å™¨</h1>
    
    <!-- Standardized Info Box -->
    <div class="info-box">
      <div>
        <strong>ä½¿ç”¨è¯´æ˜ï¼š</strong> è¾“å…¥æ‰€æœ‰å•†å“çš„å•ä»·ã€æ•°é‡ã€ç›®æ ‡å•ç¬”é‡‘é¢ã€ç›®æ ‡å•æ•°ï¼Œè®¡ç®—å™¨ä¼šå°†å•†å“æ‹†åˆ†æˆå°½å¯èƒ½å¤šçš„è®¢å•ã€‚
      </div>
    </div>
    
    <!-- Step 1: Inventory -->
    <div class="section-title">ç¬¬ä¸€æ­¥ï¼šå•†å“åº“å­˜</div>
    <div id="items-container"></div>
    <button class="btn-add" onclick="addItemRow()">+ æ·»åŠ ä¸€è¡Œå•†å“</button>

    <!-- Step 2: Targets -->
    <div class="section-title">ç¬¬äºŒæ­¥ï¼šè®¾ç½®ç›®æ ‡è®¢å•</div>
    <div id="targetContainer"></div>
    <button class="btn-add" onclick="addTargetRow()">+ æ·»åŠ ç›®æ ‡é‡‘é¢</button>
    
    <div class="input-row" style="margin-top: 20px; background: var(--card-bg); box-shadow:var(--shadow-card);">
      <div class="input-group">
        <label>ç»Ÿä¸€å…è®¸è¯¯å·® (Â¥)</label>
        <input type="number" id="errt" value="5" onchange="saveData()">
      </div>
    </div>

    <button class="btn-primary" onclick="calculate()">è®¡ç®—æœ€ä½³æ–¹æ¡ˆ</button>
    <div id="errorMsg" style="display:none; margin-top:20px; padding:15px; background:var(--error-bg); color:var(--error-text); border-radius:12px; text-align:center;"></div>

    <!-- Results -->
    <div id="resultsSection" class="results-area">
      <h2>è®¡ç®—ç»“æœ</h2>
      <p style="color:var(--text-light); margin-bottom:15px; font-size:0.9rem;">ç‚¹å‡»ä¸‹æ–¹å¡ç‰‡æŸ¥çœ‹ä¸åŒç®—æ³•çš„åˆ†é…ç»“æœï¼š</p>
      
      <div id="schemeComparison" class="scheme-grid"></div>
      
      <div id="detailedResults"></div>
    </div>
  </div>

  <script>
    // --- Init ---
    document.addEventListener('DOMContentLoaded', () => {
      loadTheme();
      loadData();
    });

    function toggleTheme() {
      const html = document.documentElement;
      const next = html.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
      html.setAttribute('data-theme', next);
      localStorage.setItem('theme', next);
      document.getElementById('themeBtn').textContent = next === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
    }
    function loadTheme() {
      const saved = localStorage.getItem('theme') || 'light';
      document.documentElement.setAttribute('data-theme', saved);
      document.getElementById('themeBtn').textContent = saved === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
    }

    // --- Data Persistence ---
    function saveData() {
      const items = [];
      document.querySelectorAll('.item-row').forEach(row => {
        items.push({
          name: row.querySelector('.name-input').value,
          price: row.querySelector('.price-input').value,
          qty: row.querySelector('.qty-input').value
        });
      });
      const targets = [];
      document.querySelectorAll('.target-row').forEach(row => {
        targets.push({
          price: row.querySelector('.t-price').value,
          count: row.querySelector('.t-count').value
        });
      });
      const data = {
        items: items,
        targets: targets,
        errt: document.getElementById('errt').value
      };
      localStorage.setItem('gamma_calc_data', JSON.stringify(data));
    }

    function loadData() {
      const saved = localStorage.getItem('gamma_calc_data');
      if (saved) {
        const data = JSON.parse(saved);
        const iContainer = document.getElementById('items-container');
        iContainer.innerHTML = '';
        if(data.items && data.items.length) {
          data.items.forEach(item => addItemRow(item.name, item.price, item.qty));
        } else {
          addItemRow();
        }
        
        const tContainer = document.getElementById('targetContainer');
        tContainer.innerHTML = '';
        if(data.targets && data.targets.length) {
          data.targets.forEach(t => addTargetRow(t.price, t.count));
        } else {
          addTargetRow();
        }
        
        document.getElementById('errt').value = data.errt || 5;
      } else {
        addItemRow(); 
        addTargetRow();
      }
    }

    function addItemRow(name='', price='', qty='') {
      const container = document.getElementById('items-container');
      const div = document.createElement('div');
      div.className = 'input-row item-row';
      div.innerHTML = `
        <div class="input-group" style="flex: 1.5;">
          <label>å•†å“å</label>
          <input type="text" class="name-input" placeholder="ä¾‹å¦‚: å§å”§" value="${name}" onchange="saveData()">
        </div>
        <div class="input-group">
          <label>å•ä»·</label>
          <input type="number" class="price-input" placeholder="0.00" value="${price}" onchange="saveData()">
        </div>
        <div class="input-group">
          <label>åº“å­˜</label>
          <input type="number" class="qty-input" placeholder="0" value="${qty}" onchange="saveData()">
        </div>
        <button class="btn-remove" onclick="this.parentElement.remove(); saveData()">âœ•</button>
      `;
      container.appendChild(div);
      saveData();
    }

    function addTargetRow(price='', count='1') {
      const container = document.getElementById('targetContainer');
      const div = document.createElement('div');
      div.className = 'target-row';
      div.innerHTML = `
        <div class="input-group">
          <label>é‡‘é¢</label>
          <input type="number" class="t-price" placeholder="188" value="${price}" onchange="saveData()">
        </div>
        <div class="input-group">
          <label>å•æ•°</label>
          <input type="number" class="t-count" value="${count}" min="1" onchange="saveData()">
        </div>
        <button class="btn-remove" onclick="this.parentElement.remove(); saveData()">âœ•</button>
      `;
      container.appendChild(div);
      saveData();
    }

    // --- Logic ---
    function calculate() {
      const errorEl = document.getElementById('errorMsg');
      errorEl.style.display = 'none';

      // 1. Read DOM
      const items = [];
      document.querySelectorAll('.item-row').forEach(row => {
        const n = row.querySelector('.name-input').value.trim();
        const p = parseFloat(row.querySelector('.price-input').value);
        const q = parseInt(row.querySelector('.qty-input').value);
        if(!isNaN(p) && p > 0 && !isNaN(q) && q > 0) {
          items.push({
            name: n || `Â¥${p}`,
            price: p,
            qty: q
          });
        }
      });

      let targets = [];
      document.querySelectorAll('.target-row').forEach(row => {
        const p = parseFloat(row.querySelector('.t-price').value);
        const c = parseInt(row.querySelector('.t-count').value);
        if(p > 0 && c > 0) {
          for(let i=0; i<c; i++) targets.push(p);
        }
      });
      
      const errt = parseFloat(document.getElementById('errt').value) || 0;

      if(!items.length) return showError("è¯·è¾“å…¥å•†å“");
      if(!targets.length) return showError("è¯·è¾“å…¥ç›®æ ‡");

      window.currentItems = items; // for display

      const prices = items.map(i => i.price);
      const inventory = items.map(i => i.qty);

      // 2. Run 3 Schemes
      // Scheme A: Input order
      const schemeA = runScheme(targets, [...inventory], prices, "æ–¹æ¡ˆ A (è¾“å…¥é¡ºåº)", errt);
      // Scheme B: Large targets first
      const schemeB = runScheme([...targets].sort((a,b)=>b-a), [...inventory], prices, "æ–¹æ¡ˆ B (å¤§é¢ä¼˜å…ˆ)", errt);
      
      // Scheme C: Random shuffle loop
      let bestSchemeC = null;
      let bestCLeftover = Infinity;
      let bestCSuccess = -1;

      // Iterate based on number of targets
      const trials = Math.max(95, targets.length * 5); 
      for(let i=0; i<trials; i++) {
        // Shuffle a copy of targets
        const shuffledTargets = [...targets].sort(() => Math.random() - 0.5);
        const scheme = runScheme(shuffledTargets, [...inventory], prices, "æ–¹æ¡ˆ C (éšæœºä¼˜åŒ–)", errt);
        
        // Pick best based on Success Count then Leftover Value
        if (!bestSchemeC || 
            scheme.successCount > bestCSuccess || 
            (scheme.successCount === bestCSuccess && scheme.leftVal < bestCLeftover)) {
          bestSchemeC = scheme;
          bestCSuccess = scheme.successCount;
          bestCLeftover = scheme.leftVal;
        }
      }

      displayResults([schemeA, schemeB, bestSchemeC]);
    }

    function showError(msg) {
      const el = document.getElementById('errorMsg');
      el.textContent = msg;
      el.style.display = 'block';
    }

    function runScheme(targetList, inv, prices, name, errt) {
      let currentInv = [...inv];
      let successCount = 0;
      let results = [];
      
      targetList.forEach(t => {
        const combo = findCombo(prices, currentInv, t, errt);
        if(combo) {
          successCount++;
          results.push({success: true, target: t, items: combo.items, total: combo.total});
          combo.items.forEach((c, i) => currentInv[i] -= c);
        } else {
          results.push({success: false, target: t});
        }
      });
      
      const leftVal = currentInv.reduce((s, c, i) => s + c * prices[i], 0);
      return { name, successCount, results, leftVal, leftoverItems: currentInv };
    }

    function findCombo(prices, inventory, target, errt) {
      const indices = prices.map((_, i) => i).sort((a,b) => prices[b] - prices[a]);
      let best = null;
      let minDiff = Infinity;
      
      function search(idx, currentItems, currentSum) {
        if (best === 0) return; 

        if(currentSum >= target && currentSum <= target + errt) {
           if(currentSum - target < minDiff) {
             minDiff = currentSum - target;
             best = [...currentItems];
           }
           return;
        }
        if(currentSum > target + errt || idx >= indices.length) return;
        
        const pIdx = indices[idx];
        const max = Math.min(inventory[pIdx], Math.floor((target+errt-currentSum)/prices[pIdx]));
        
        for(let q=max; q>=0; q--) {
          currentItems[pIdx] = q;
          search(idx+1, currentItems, currentSum + q*prices[pIdx]);
          currentItems[pIdx] = 0;
          if(minDiff === 0) break;
        }
      }
      search(0, new Array(prices.length).fill(0), 0);
      
      return best ? {items: best, total: best.reduce((s,c,i)=>s+c*prices[i],0)} : null;
    }

    // --- Display ---
    function displayResults(schemes) {
      const container = document.getElementById('schemeComparison');
      container.innerHTML = '';
      
      // Sort: Most successes, then least leftover value
      schemes.sort((a,b) => b.successCount - a.successCount || a.leftVal - b.leftVal);
      window.savedSchemes = schemes;

      schemes.forEach((s, idx) => {
        container.innerHTML += `
          <div class="scheme-card ${idx===0?'active':''}" onclick="showSchemeDetails(${idx}); highlightCard(this)">
            <div class="scheme-name">${s.name}</div>
            <div class="scheme-stat">æˆåŠŸ: ${s.successCount}/${s.results.length}</div>
            <div class="scheme-stat">å‰©ä½™: Â¥${s.leftVal.toFixed(2)}</div>
          </div>
        `;
      });
      
      showSchemeDetails(0);
      document.getElementById('resultsSection').style.display = 'block';
      document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
    }
    
    window.highlightCard = function(el) {
      document.querySelectorAll('.scheme-card').forEach(c => c.classList.remove('active'));
      el.classList.add('active');
    }
    
    window.showSchemeDetails = function(idx) {
       const s = window.savedSchemes[idx];
       const items = window.currentItems;
       let html = `<h3 style="color:var(--primary-color); border-bottom:1px solid var(--input-bg); padding-bottom:15px; margin-top:0;">${s.name} è¯¦æƒ…</h3>`;
       
       // Sort results: Descending Total Price
       const sortedResults = [...s.results].sort((a, b) => {
         if (a.success && !b.success) return -1;
         if (!a.success && b.success) return 1;
         return b.total - a.total; // Descending
       });

       sortedResults.forEach((r, i) => {
         if(r.success) {
           const itemsHtml = r.items.map((c, idx) => c > 0 ? `<span class="res-tag">${c} x ${items[idx].name} (Â¥${items[idx].price})</span>` : '').join('');
           
           html += `
             <div style="background:var(--row-bg); padding:20px; border-radius:16px; margin-bottom:15px; box-shadow:var(--shadow-card); border: 1px solid var(--input-bg);">
               <div style="font-weight:700; color:var(--primary-color); margin-bottom:10px; font-size:1.1rem;">
                 ğŸ“¦ è®¢å• ${i+1} <span style="color:var(--text-color); font-weight:400; font-size:0.9rem; float:right;">ç›®æ ‡: Â¥${r.target} | å®é™…: Â¥${r.total.toFixed(2)}</span>
               </div>
               <div style="display:flex; flex-wrap:wrap; gap:8px;">${itemsHtml}</div>
             </div>
           `;
         } else {
           html += `
             <div style="background:var(--error-bg); color:var(--error-text); padding:20px; border-radius:16px; margin-bottom:15px; box-shadow:var(--shadow-card);">
               <div style="font-weight:700;">âš ï¸ è®¢å• ${i+1} (ç›®æ ‡ Â¥${r.target})</div>
               <div style="font-size:0.9rem;">æ— æ³•ç»„æˆç¬¦åˆæ¡ä»¶çš„è®¢å•</div>
             </div>`;
         }
       });
       
       // Add Remaining Items Table
       if (s.leftVal > 0 && s.leftoverItems) {
         html += `
           <h3 style="margin-top:30px; margin-bottom:15px;">å‰©ä½™å•†å“ (æ€»å€¼: Â¥${s.leftVal.toFixed(2)})</h3>
           <div class="table-responsive">
             <table>
               <tr>${items.map(i => `<th>${i.name}</th>`).join('')}</tr>
               <tr>${s.leftoverItems.map(c => `<td>${c}</td>`).join('')}</tr>
             </table>
           </div>
         `;
       } else if (s.leftVal <= 0) {
         html += `<div class="summary-card" style="background:var(--success-bg); color:var(--success-text); margin-top:30px;">ğŸ‰ å®Œç¾ï¼æ‰€æœ‰å•†å“å·²åˆ†é…å®Œæ¯•ã€‚</div>`;
       }

       // Inject styles for tags similar to Split Calculator
       if(!document.getElementById('gamma-tag-style')) {
         const style = document.createElement('style');
         style.id = 'gamma-tag-style';
         style.innerHTML = `
           .tag { display:inline-block; background:var(--input-bg); padding:6px 12px; border-radius:20px; font-size:0.9rem; color:var(--text-color); }
         `;
         document.head.appendChild(style);
       }

       document.getElementById('detailedResults').innerHTML = html;
    }
  </script>
</body>
</html>