<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <title>å‡‘å•è®¡ç®—å™¨</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 40px;
      background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
      min-height: 100vh;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(33, 150, 243, 0.2);
      padding: 40px;
      position: relative;
      border: 1px solid #e1f5fe;
    }

    h1 {
      text-align: center;
      color: #1565c0;
      margin-bottom: 30px;
      font-size: 2.2em;
      text-shadow: 0 2px 4px rgba(21, 101, 192, 0.1);
    }

    .input-section {
      margin-bottom: 25px;
    }

    .input-row {
      margin: 15px 0;
      padding: 15px;
      background: #f8fbff;
      border-radius: 8px;
      border-left: 4px solid #42a5f5;
      transition: all 0.3s ease;
    }

    .input-row:hover {
      background: #e3f2fd;
      transform: translateX(5px);
    }

    label {
      font-weight: 600;
      color: #1976d2;
      margin-right: 10px;
    }

    input {
      padding: 10px 12px;
      margin: 0 10px;
      border: 2px solid #e1f5fe;
      border-radius: 6px;
      font-size: 14px;
      transition: all 0.3s ease;
    }

    input:focus {
      outline: none;
      border-color: #42a5f5;
      box-shadow: 0 0 0 3px rgba(66, 165, 245, 0.1);
    }

    .parameters {
      background: #f8fbff;
      padding: 20px;
      border-radius: 10px;
      margin: 25px 0;
      border-left: 4px solid #ba68c8;
    }

    .parameters label {
      color: #6a1b9a;
    }

    .parameters input {
      border-color: #e1bee7;
    }

    .parameters input:focus {
      border-color: #ba68c8;
      box-shadow: 0 0 0 3px rgba(186, 104, 200, 0.1);
    }

    button {
      padding: 15px 30px;
      font-size: 18px;
      margin-top: 20px;
      background: linear-gradient(135deg, #42a5f5, #1976d2);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(66, 165, 245, 0.4);
      font-weight: 600;
      width: 100%;
    }

    button:hover {
      background: linear-gradient(135deg, #1e88e5, #1565c0);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(66, 165, 245, 0.6);
    }

    .error {
      color: #d32f2f;
      font-weight: bold;
      margin-top: 15px;
      padding: 15px;
      background: #ffebee;
      border-radius: 8px;
      border-left: 4px solid #f44336;
      text-align: center;
    }

    .input-group {
      display: inline-block;
      margin: 0 15px;
    }

    .section-title {
      color: #1565c0;
      font-size: 1.1em;
      font-weight: 600;
      margin-bottom: 15px;
      padding-bottom: 5px;
      border-bottom: 2px solid #e3f2fd;
    }

    .info-box {
      background: #e8f5e9;
      border-left: 4px solid #66bb6a;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      color: #2e7d32;
    }

    .price-list-input {
      width: 300px;
      padding: 12px;
      font-size: 16px;
    }

    #inventorySection {
      display: none;
    }

    .setup-btn {
      width: auto !important;
      margin-top: 0 !important;
    }

    /* Results section styles */
    #resultsSection {
      display: none;
      margin-top: 40px;
      padding-top: 20px;
      border-top: 2px dashed #42a5f5;
    }

    .summary {
      text-align: center;
      font-size: 1.2em;
      color: #546e7a;
      margin-bottom: 30px;
      padding: 15px;
      background: #e3f2fd;
      border-radius: 10px;
      border-left: 4px solid #42a5f5;
      box-shadow: 0 2px 8px rgba(33, 150, 243, 0.1);
    }

    .results-count {
      font-weight: bold;
      color: #1565c0;
      font-size: 1.3em;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 20px;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 5px 15px rgba(33, 150, 243, 0.1);
      background: white;
    }

    th,
    td {
      border: 1px solid #e1f5fe;
      padding: 15px 12px;
      text-align: center;
      transition: background-color 0.2s ease;
    }

    th {
      background: linear-gradient(135deg, #42a5f5, #1976d2);
      color: white;
      font-weight: 600;
      font-size: 1.1em;
    }

    td {
      background: #fafafa;
    }

    tr:hover td {
      background: #e3f2fd;
    }

    .no-results {
      text-align: center;
      padding: 40px;
      color: #546e7a;
      font-size: 1.2em;
      background: #e3f2fd;
      border-radius: 10px;
      margin-top: 20px;
      border: 1px solid #bbdefb;
    }

    /* Dynamic column width based on data */
    th:nth-child(n),
    td:nth-child(n) {
      min-width: 80px;
    }

    /* Light purple total column */
    th:last-child {
      background: linear-gradient(135deg, #ba68c8, #8e24aa);
      color: white;
      font-weight: bold;
    }

    td:last-child {
      background: #f3e5f5;
      color: #6a1b9a;
      font-weight: bold;
    }

    tr:hover td:last-child {
      background: #e1bee7;
    }

    .reset-btn {
      background: linear-gradient(135deg, #ef5350, #d32f2f) !important;
      width: auto !important;
      margin-top: 10px !important;
    }

    .reset-btn:hover {
      background: linear-gradient(135deg, #e53935, #c62828) !important;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>å‡‘å•è®¡ç®—å™¨</h1>

    <div class="contact-info" style="text-align: center; color: #666; margin-bottom: 20px; font-size: 0.9em;">
      é‡åˆ°äº†bugæˆ–è€…æƒ³ç»™ä¸€ç‚¹å»ºè®®ï¼Ÿ
          <br>è¯·åœ¨
          <a href="http://xhslink.com/o/2x2YmjdAGOo" target="_blank" style="color: #42a5f5; text-decoration: none;">
            å°çº¢ä¹¦å’‹è‚¥å››é¸­
          </a>è”ç³»æˆ‘ğŸ’œ
    </div>

    <div class="info-box">
      <strong>ä½¿ç”¨è¯´æ˜ï¼š</strong> å…ˆè¾“å…¥è°·å­çš„å•ä»·ï¼Œç„¶åè¾“å…¥æ¯ä¸ªä»·æ ¼çš„è°·å­æœ€å°‘éœ€è¦å¤šå°‘ä»½ã€ç›®æ ‡æ€»ä»·å’Œå…è®¸è¶…å‡ºçš„é‡‘é¢ï¼Œè®¡ç®—å™¨ä¼šæ‰¾å‡ºæ‰€æœ‰æ»¡è¶³æ¡ä»¶çš„æ»¡èµ æ–¹æ¡ˆã€‚
    </div>

    <!-- Step 1: Price List Input -->
    <div class="section-title">ç¬¬ä¸€æ­¥ï¼šè¯·è¾“å…¥è°·å­å•ä»·</div>
    <div class="input-row">
      <div class="input-group">
        <label>è°·å­å•ä»·ï¼ˆç”¨ç©ºæ ¼åˆ†å¼€ï¼‰ï¼š</label>
        <input type="text" id="priceList" class="price-list-input" placeholder="æ¯”å¦‚18 24 32 59 129" required>
      </div>
      <button type="button" onclick="setupInventoryInputs()" class="setup-btn">å¼€å§‹è¾“å…¥æ•°é‡</button>
    </div>

    <!-- Step 2: Inventory Inputs (dynamically generated) -->
    <div id="inventorySection">
      <div class="section-title">ç¬¬äºŒæ­¥ï¼šè¯·è¾“å…¥æ¯ä¸ªå•ä»·çš„æœ€ä½æ•°é‡</div>
      <form id="inventoryForm"></form>

      <div class="parameters">
        <div class="section-title" style="color: #6a1b9a;">ç¬¬ä¸‰æ­¥ï¼šè¯·è¾“å…¥è®¡ç®—å‚æ•°</div>
        <div class="input-row">
          <div class="input-group">
            <label>ç›®æ ‡æ€»ä»·: </label>
            <input type="number" id="target" min="1" placeholder="æ¯”å¦‚188" required>
          </div>
          <div class="input-group">
            <label>æ€»ä»·å¯ä»¥è¶…å‡º: </label>
            <input type="number" id="errt" value="0" min="0" required>
          </div>
        </div>
      </div>

      <button type="button" onclick="calculateCombinations()">è®¡ç®—æ»¡èµ æ–¹æ¡ˆ</button>
    </div>

    <div id="errorMsg" class="error"></div>

    <!-- Results Section -->
    <div id="resultsSection">
      <h1 style="margin-top: 0;">æ»¡èµ æ–¹æ¡ˆè®¡ç®—ç»“æœ</h1>

  <div style="text-align: center; margin-bottom: 30px;">
    <button type="button" onclick="resetCalculator()" class="reset-btn">é‡æ–°è®¡ç®—</button>
  </div>

      <div class="summary" id="resultsSummary">
        <!-- Summary will be populated by JavaScript -->
      </div>

      <table id="resultsTable"></table>
    </div>
  </div>

  <script>
    function setupInventoryInputs() {
      const priceListInput = document.getElementById('priceList').value;
      const errorMsg = document.getElementById('errorMsg');

      if (!priceListInput.trim()) {
        errorMsg.textContent = "è¯·è¾“å…¥ä»·æ ¼ã€‚";
        return;
      }

      // Parse prices from SPACE-separated list
      const prices = priceListInput.split(/\s+/) // Split by one or more spaces
        .map(price => parseFloat(price.trim()))
        .filter(price => !isNaN(price) && price > 0);

      if (prices.length === 0) {
        errorMsg.textContent = "è¯·è¾“å…¥å¤§äº0çš„ä»·æ ¼ã€‚";
        return;
      }

      // Check for duplicate prices
      const uniquePrices = new Set(prices);
      if (uniquePrices.size !== prices.length) {
        errorMsg.textContent = "è¯·è¾“å…¥ä¸ç›¸åŒçš„ä»·æ ¼ã€‚";
        return;
      }

      // Store prices for later use
      window.prices = prices;

      // Generate inventory input fields
      const form = document.getElementById('inventoryForm');
      form.innerHTML = ''; // Clear previous inputs

      prices.forEach((price, index) => {
        const div = document.createElement("div");
        div.classList.add("input-row");
        div.innerHTML = `
          <div class="input-group">
            <label>ä»·æ ¼ Â¥${price.toFixed(2)}: </label>
            <input type="number" id="min_item${index}" value="0" min="0" placeholder="æœ€ä½æ•°é‡" required>
          </div>
        `;
        form.appendChild(div);
      });

      // Show inventory section
      document.getElementById('inventorySection').style.display = 'block';
      errorMsg.textContent = '';

      console.log("Prices set:", prices);
    }

    function dot(a, b) {
      return a.reduce((sum, val, i) => sum + val * b[i], 0);
    }

    function calculateCombinations() {
      if (!window.prices || window.prices.length === 0) {
        document.getElementById("errorMsg").textContent = "è¯·è¾“å…¥ä»·æ ¼ã€‚";
        return;
      }

      const min_items = [];
      for (let i = 0; i < window.prices.length; i++) {
        const m = parseInt(document.getElementById(`min_item${i}`).value);
        if (isNaN(m) || m < 0) {
          document.getElementById("errorMsg").textContent = "è¯·è¾“å…¥ä¸å°äº0çš„æœ€ä½æ•°é‡ã€‚";
          return;
        }
        min_items.push(m);
      }

      const target = parseFloat(document.getElementById("target").value);
      const errt = parseFloat(document.getElementById("errt").value) || 0;

      if (isNaN(target) || target <= 0) {
        document.getElementById("errorMsg").textContent = "è¯·è¾“å…¥å¤§äº0çš„ç›®æ ‡æ€»ä»·ã€‚";
        return;
      }

      console.log("Prices:", window.prices);
      console.log("Min items:", min_items);
      console.log("Target:", target, "Error tolerance:", errt);

      const result = calculateCombinationsInternal(window.prices, min_items, target, errt);

      // Display results
      displayResults(result, window.prices, target, errt);
    }

    function calculateCombinationsInternal(prar, min_items, target, errt) {
      const baseDot = prar.reduce((sum, p, i) => sum + p * min_items[i], 0);
      const line = target - baseDot;

      if (line < 0) {
        return {
          success: false,
          message: "ä½ çš„æœ€ä½æ•°é‡å¯¹åº”ä»·æ ¼å·²ç»è¶…è¿‡äº†ç›®æ ‡æ€»ä»·ï¼Œè¯·å¢åŠ ç›®æ ‡æ€»ä»·ã€‚",
          results: []
        };
      }

      // Sort descending by price
      const combined = prar.map((p, i) => ({ price: p, min: min_items[i] }))
        .sort((a, b) => b.price - a.price);
      const sortedPrar = combined.map(obj => obj.price);
      const minSorted = combined.map(obj => obj.min);

      console.log("Computed line =", line);

      const multi = sortedPrar.map(p => Math.ceil(line / p + 0.1));
      const counter = Array(sortedPrar.length).fill(0);
      const results = [];
      console.log("Multiplicity cap:", multi);
      console.log("Counter:", counter);

      while (counter[0] < multi[0]) {
        // Calculate current amount with counter only
        let amount = dot(counter, sortedPrar);

        // If amount < line, max out last item
        if (amount < line) {
          const remaining = Math.ceil((line - amount) / sortedPrar[sortedPrar.length - 1]);
          counter[counter.length - 1] += remaining;
          amount = dot(counter, sortedPrar);

          // Check if this new combination is valid
          if (amount >= line && (amount - line) <= errt) {
            const items = minSorted.map((m, i) => m + counter[i]);
            const totalAmount = dot(items, sortedPrar);
            results.push([...items, totalAmount]);
          }
        }

        // Now amount >= line, jump the rightmost nonzero index until amount < line again
        while (amount >= line) {
          // Find rightmost nonzero index
          let rind = -1;
          for (let i = counter.length - 1; i >= 0; i--) {
            if (counter[i] > 0) {
              rind = i;
              break;
            }
          }

          if (rind > 0) {
            counter[rind] = 0;
            rind -= 1;
            counter[rind] += 1;
          } else {
            break;
          }

          // Handle carryovers
          while (rind > 0 && counter[rind] >= multi[rind]) {
            counter[rind] = 0;
            rind -= 1;
            counter[rind] += 1;
          }

          amount = dot(counter, sortedPrar);

          // Check if this new combination is valid
          if (amount >= line && (amount - line) <= errt) {
            const items = minSorted.map((m, i) => m + counter[i]);
            const totalAmount = dot(items, sortedPrar);
            results.push([...items, totalAmount]);
          }
        }

        // Increment counter for next iteration
        let curind = counter.length - 1;
        counter[curind] += 1;

        // Handle counter overflow
        while (curind > 0 && counter[curind] >= multi[curind]) {
          counter[curind] = 0;
          curind--;
          counter[curind]++;
        }

        // Safety break to prevent infinite loops
        if (results.length > 5000) {
          console.warn("Safety break: Too many results");
          break;
        }
      }

      return {
        success: true,
        results: results,
        sortedPrices: sortedPrar
      };
    }

    function displayResults(result, prices, target, errt) {
      // Update summary
      const summaryElement = document.getElementById('resultsSummary');
      const table = document.getElementById("resultsTable");
      table.innerHTML = '';

      if (!result.success) {
        summaryElement.innerHTML = result.message;
        summaryElement.style.background = '#ffebee';
        summaryElement.style.borderLeftColor = '#e57373';
      } else if (result.results.length === 0) {
        summaryElement.innerHTML = 'æ²¡æœ‰æ‰¾åˆ°ä½ æƒ³è¦çš„æ–¹æ¡ˆã€‚';
        summaryElement.style.background = '#fff5f5';
        summaryElement.style.borderLeftColor = '#ff6b6b';
      } else {
        summaryElement.innerHTML = `æ‰¾åˆ°äº†<span class="results-count">${result.results.length}</span>ç§æ»¡èµ æ–¹æ¡ˆï¼š`;
        summaryElement.style.background = '#e8f5e9';
        summaryElement.style.borderLeftColor = '#66bb6a';
        summaryElement.style.color = '#2e7d32';

        if (result.results.length > 1000) {
          document.getElementById("errorMsg").textContent = "æ‰¾åˆ°äº†è¶…è¿‡1000ç§æ–¹æ¡ˆï¼Œè¯·è€ƒè™‘å¢åŠ æœ€ä½æ•°é‡ã€‚";
        }

        // Render results table
        const headerRow = document.createElement("tr");
        result.sortedPrices.forEach(p => {
          const th = document.createElement("th");
          th.textContent = "Â¥" + p;
          headerRow.appendChild(th);
        });
        const totalHeader = document.createElement("th");
        totalHeader.textContent = "æ€»ä»·";
        headerRow.appendChild(totalHeader);
        table.appendChild(headerRow);

        result.results.forEach(row => {
          const tr = document.createElement("tr");
          row.forEach(val => {
            const td = document.createElement("td");
            td.textContent = val;
            tr.appendChild(td);
          });
          table.appendChild(tr);
        });
      }

      // Show results section
      document.getElementById('resultsSection').style.display = 'block';

      // Scroll to results
      document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
    }

    function resetCalculator() {
      // Reset form
      document.getElementById('priceList').value = '';
      document.getElementById('inventoryForm').innerHTML = '';
      document.getElementById('inventorySection').style.display = 'none';
      document.getElementById('resultsSection').style.display = 'none';
      document.getElementById('errorMsg').textContent = '';

      // Scroll to top
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Allow pressing Enter in the price list input to trigger setup
    document.getElementById('priceList').addEventListener('keypress', function (e) {
      if (e.key === 'Enter') {
        setupInventoryInputs();
      }
    });
  </script>
</body>

</html>