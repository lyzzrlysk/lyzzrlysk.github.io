<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å‡‘å•è®¡ç®—å™¨</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <!-- Circular Home Button -->
    <a href="index.html" class="btn-home" aria-label="Home">ğŸ </a>
    
    <button class="theme-toggle" onclick="toggleTheme()" id="themeBtn">ğŸŒ™</button>

    <h1>å‡‘å•è®¡ç®—å™¨</h1>
    
    <div class="info-box">
      <div>
        <strong>ä½¿ç”¨è¯´æ˜ï¼š</strong> è¾“å…¥å•†å“çš„å•ä»·ã€<b>æœ€ä½</b>éœ€è¦çš„æ•°é‡ã€ç›®æ ‡æ€»ä»·ï¼Œè®¡ç®—å™¨ä¼šç»™å‡ºæœ€æ¥è¿‘ç›®æ ‡çš„æ–¹æ¡ˆã€‚
      </div>
    </div>

    <!-- Step 1: Items -->
    <div class="section-title">ç¬¬ä¸€æ­¥ï¼šæ·»åŠ å•†å“</div>
    <div id="items-container"></div>
    <button class="btn-add" onclick="addItemRow()">+ æ·»åŠ ä¸€è¡Œå•†å“</button>

    <!-- Step 2: Parameters -->
    <div class="section-title">ç¬¬äºŒæ­¥ï¼šè®¾ç½®ç›®æ ‡</div>
    <div class="input-row" style="background: var(--card-bg); box-shadow: var(--shadow-card);">
      <div class="input-group">
        <label>ç›®æ ‡æ€»ä»· (Â¥)</label>
        <input type="number" id="target" placeholder="ä¾‹å¦‚ 300" onchange="saveData()">
      </div>
      <div class="input-group">
        <label>å…è®¸è¶…å‡º (Â¥)</label>
        <input type="number" id="errt" value="0" min="0" onchange="saveData()">
      </div>
    </div>

    <button class="btn-primary" onclick="calculate()">å¼€å§‹è®¡ç®—</button>
    
    <!-- Error Message -->
    <div id="errorMsg" style="display:none; margin-top:20px; padding:15px; background:var(--error-bg); color:var(--error-text); border-radius:12px; text-align:center;"></div>

    <!-- Results -->
    <div id="resultsSection" class="results-area">
      <h2>è®¡ç®—ç»“æœ</h2>
      <div id="resultsSummary" class="summary-card"></div>
      
      <!-- Table wrapper with sticky header enabled via CSS -->
      <div class="table-responsive">
        <table id="resultsTable"></table>
      </div>
      
      <button onclick="window.scrollTo({top:0, behavior:'smooth'})" style="background:var(--input-bg); color:var(--text-color); width:100%; margin-top:30px;">â†‘ å›åˆ°é¡¶éƒ¨</button>
    </div>
  </div>

  <script>
    // --- Init ---
    document.addEventListener('DOMContentLoaded', () => {
      loadTheme();
      loadData();
    });

    // --- Theme Logic ---
    function toggleTheme() {
      const html = document.documentElement;
      const next = html.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
      html.setAttribute('data-theme', next);
      localStorage.setItem('theme', next);
      document.getElementById('themeBtn').textContent = next === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
    }
    function loadTheme() {
      const saved = localStorage.getItem('theme') || 'light';
      document.documentElement.setAttribute('data-theme', saved);
      document.getElementById('themeBtn').textContent = saved === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
    }

    // --- Data Persistence ---
    function saveData() {
      const items = [];
      document.querySelectorAll('.item-row').forEach(row => {
        items.push({
          name: row.querySelector('.name-input').value,
          price: row.querySelector('.price-input').value,
          qty: row.querySelector('.qty-input').value
        });
      });
      const data = {
        items: items,
        target: document.getElementById('target').value,
        errt: document.getElementById('errt').value
      };
      localStorage.setItem('fill_calc_data', JSON.stringify(data));
    }

    function loadData() {
      const saved = localStorage.getItem('fill_calc_data');
      const container = document.getElementById('items-container');
      container.innerHTML = '';
      
      if (saved) {
        const data = JSON.parse(saved);
        if (data.items && data.items.length > 0) {
          data.items.forEach(item => addItemRow(item.name, item.price, item.qty));
        } else {
          initEmptyRows();
        }
        document.getElementById('target').value = data.target || '';
        document.getElementById('errt').value = data.errt || 0;
      } else {
        initEmptyRows();
      }
    }

    function initEmptyRows() {
      addItemRow(); addItemRow(); addItemRow();
    }

    // --- UI Logic ---
    function addItemRow(name = '', price = '', qty = '') {
      const container = document.getElementById('items-container');
      const div = document.createElement('div');
      div.className = 'input-row item-row';
      div.innerHTML = `
        <div class="input-group" style="flex: 1.5;">
          <label>å•†å“å (é€‰å¡«)</label>
          <input type="text" class="name-input" placeholder="ä¾‹å¦‚: å§å”§" value="${name}" onchange="saveData()">
        </div>
        <div class="input-group">
          <label>å•ä»· (Â¥)</label>
          <input type="number" class="price-input" placeholder="0.00" min="0" step="0.01" value="${price}" onchange="saveData()">
        </div>
        <div class="input-group">
          <label>æœ€ä½æ•°é‡</label>
          <input type="number" class="qty-input" placeholder="0" min="0" value="${qty}" onchange="saveData()">
        </div>
        <button class="btn-remove" onclick="this.parentElement.remove(); saveData()">âœ•</button>
      `;
      container.appendChild(div);
      saveData();
    }

    // --- Algorithm: Recursive Combination Finder ---
    function calculate() {
      const errorEl = document.getElementById('errorMsg');
      errorEl.style.display = 'none';

      const items = [];
      
      // Read Inputs
      document.querySelectorAll('.item-row').forEach(row => {
        const n = row.querySelector('.name-input').value.trim();
        const p = parseFloat(row.querySelector('.price-input').value);
        const q = parseInt(row.querySelector('.qty-input').value);
        if (!isNaN(p) && p > 0) {
          items.push({
            name: n || `Â¥${p}`,
            price: p,
            min: isNaN(q) ? 0 : q
          });
        }
      });

      const target = parseFloat(document.getElementById('target').value);
      const errt = parseFloat(document.getElementById('errt').value) || 0;

      if (items.length === 0) return showError("è¯·è‡³å°‘è¾“å…¥ä¸€ä¸ªæœ‰æ•ˆçš„å•†å“å•ä»·ã€‚");
      if (isNaN(target) || target <= 0) return showError("è¯·è¾“å…¥æœ‰æ•ˆçš„ç›®æ ‡æ€»ä»·ã€‚");

      // --- SORTING ITEMS BY PRICE DESCENDING BEFORE CALCULATION ---
      items.sort((a, b) => b.price - a.price);

      // Logic
      const results = [];
      const len = items.length;
      const prices = items.map(i => i.price);
      const minItems = items.map(i => i.min);

      const baseCost = items.reduce((sum, item) => sum + item.price * item.min, 0);
      
      if (baseCost > target + errt) {
        return showError(`æœ€ä½æ•°é‡çš„æ€»ä»· (Â¥${baseCost}) å·²ç»è¶…è¿‡äº†ä¸Šé™ (Â¥${target+errt})ã€‚`);
      }

      const remainingMin = Math.max(0, target - baseCost);
      const remainingMax = target + errt - baseCost;

      function search(index, currentCounts, currentSum) {
        if (results.length > 500) return; // Limit results

        if (currentSum >= remainingMin && currentSum <= remainingMax) {
          const totalCounts = currentCounts.map((c, i) => c + minItems[i]);
          const totalVal = totalCounts.reduce((s, c, i) => s + c * prices[i], 0);
          results.push([...totalCounts, totalVal]);
        }

        if (currentSum > remainingMax || index >= len) return;

        const price = prices[index];
        const maxQty = Math.floor((remainingMax - currentSum) / price);

        for (let q = 0; q <= maxQty; q++) {
          currentCounts[index] = q;
          search(index + 1, currentCounts, currentSum + (q * price));
          currentCounts[index] = 0; // Backtrack
        }
      }

      search(0, new Array(len).fill(0), 0);

      // --- New Sorting Logic for Rows ---
      results.sort((a, b) => {
        // Priority 1: Total Price (Ascending)
        const totalA = a[a.length - 1];
        const totalB = b[b.length - 1];
        if (Math.abs(totalA - totalB) > 0.001) {
          return totalA - totalB;
        }

        // Priority 2: Quantity of Most Expensive Items (Descending)
        for (let i = 0; i <= len - 1; i++) {
          if (a[i] !== b[i]) {
            return b[i] - a[i]; 
          }
        }
        return 0;
      });

      displayResults(results, items);
    }

    function showError(msg) {
      const el = document.getElementById('errorMsg');
      el.textContent = msg;
      el.style.display = 'block';
    }

    function displayResults(results, items) {
      const section = document.getElementById('resultsSection');
      const summary = document.getElementById('resultsSummary');
      const table = document.getElementById('resultsTable');
      
      section.style.display = 'block';
      
      if (results.length === 0) {
        summary.innerHTML = "æœªæ‰¾åˆ°æ»¡è¶³æ¡ä»¶çš„æ–¹æ¡ˆ";
        summary.style.backgroundColor = "var(--error-bg)";
        summary.style.color = "var(--error-text)";
        table.innerHTML = '';
        return;
      }

      summary.innerHTML = `æˆåŠŸæ‰¾åˆ° <b>${results.length}</b> ç§æ–¹æ¡ˆ`;
      summary.style.backgroundColor = "var(--success-bg)";
      summary.style.color = "var(--success-text)";

      // Build Table Headers
      let headerHTML = '<thead><tr>';
      items.forEach(item => { 
        headerHTML += `<th>${item.name}<br><small style="font-weight:400; opacity:0.8;">Â¥${item.price}</small></th>`; 
      });
      headerHTML += '<th>æ€»ä»·</th></tr></thead>';
      table.innerHTML = headerHTML;

      const tbody = document.createElement('tbody');
      results.forEach(row => {
        const tr = document.createElement('tr');
        for (let i = 0; i < row.length - 1; i++) {
          const td = document.createElement('td');
          td.textContent = row[i];
          tr.appendChild(td);
        }
        const totalTd = document.createElement('td');
        totalTd.innerHTML = `<b>Â¥${row[row.length-1].toFixed(2)}</b>`;
        tr.appendChild(totalTd);
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      
      section.scrollIntoView({ behavior: 'smooth' });
    }
  </script>
</body>
</html>