<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <title>æ‹†å•è®¡ç®—å™¨</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 40px;
      background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
      min-height: 100vh;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(33, 150, 243, 0.2);
      padding: 40px;
      position: relative;
      border: 1px solid #e1f5fe;
    }

    h1 {
      text-align: center;
      color: #1565c0;
      margin-bottom: 30px;
      font-size: 2.2em;
      text-shadow: 0 2px 4px rgba(21, 101, 192, 0.1);
    }

    .input-section {
      margin-bottom: 25px;
    }

    .input-row {
      margin: 15px 0;
      padding: 15px;
      background: #f8fbff;
      border-radius: 8px;
      border-left: 4px solid #42a5f5;
      transition: all 0.3s ease;
    }

    .input-row:hover {
      background: #e3f2fd;
      transform: translateX(5px);
    }

    label {
      font-weight: 600;
      color: #1976d2;
      margin-right: 10px;
    }

    input {
      padding: 10px 12px;
      margin: 0 10px;
      border: 2px solid #e1f5fe;
      border-radius: 6px;
      font-size: 14px;
      transition: all 0.3s ease;
    }

    input:focus {
      outline: none;
      border-color: #42a5f5;
      box-shadow: 0 0 0 3px rgba(66, 165, 245, 0.1);
    }

    .parameters {
      background: #f8fbff;
      padding: 20px;
      border-radius: 10px;
      margin: 25px 0;
      border-left: 4px solid #ba68c8;
    }

    .parameters label {
      color: #6a1b9a;
    }

    .parameters input {
      border-color: #e1bee7;
    }

    .parameters input:focus {
      border-color: #ba68c8;
      box-shadow: 0 0 0 3px rgba(186, 104, 200, 0.1);
    }

    button {
      padding: 15px 30px;
      font-size: 18px;
      margin-top: 20px;
      background: linear-gradient(135deg, #42a5f5, #1976d2);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(66, 165, 245, 0.4);
      font-weight: 600;
      width: 100%;
    }

    button:hover {
      background: linear-gradient(135deg, #1e88e5, #1565c0);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(66, 165, 245, 0.6);
    }

    .error {
      color: #d32f2f;
      font-weight: bold;
      margin-top: 15px;
      padding: 15px;
      background: #ffebee;
      border-radius: 8px;
      border-left: 4px solid #f44336;
      text-align: center;
    }

    .input-group {
      display: inline-block;
      margin: 0 15px;
    }

    .section-title {
      color: #1565c0;
      font-size: 1.1em;
      font-weight: 600;
      margin-bottom: 15px;
      padding-bottom: 5px;
      border-bottom: 2px solid #e3f2fd;
    }

    .info-box {
      background: #e8f5e9;
      border-left: 4px solid #66bb6a;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      color: #2e7d32;
    }

    .price-list-input {
      width: 300px;
      padding: 12px;
      font-size: 16px;
    }

    .price-list-example {
      color: #666;
      font-size: 0.9em;
      margin-top: 5px;
      font-style: italic;
    }

    #inventorySection {
      display: none;
    }

    .setup-btn {
      width: auto !important;
      margin-top: 0 !important;
    }

    /* Results section styles */
    #resultsSection {
      display: none;
      margin-top: 40px;
      padding-top: 20px;
      border-top: 2px dashed #42a5f5;
    }

    .summary {
      text-align: center;
      font-size: 1.2em;
      color: #666;
      margin-bottom: 30px;
      padding: 20px;
      background: #f8f9ff;
      border-radius: 10px;
      border-left: 4px solid #667eea;
    }

    .results-count {
      font-weight: bold;
      color: #667eea;
      font-size: 1.3em;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      text-align: center;
      border-left: 4px solid #42a5f5;
    }

    .stat-card.success {
      border-left-color: #66bb6a;
    }

    .stat-card.warning {
      border-left-color: #42a5f5;
    }

    .stat-card.danger {
      border-left-color: #ef5350;
    }

    .stat-value {
      font-size: 2em;
      font-weight: bold;
      color: #1565c0;
    }

    .stat-label {
      color: #666;
      margin-top: 5px;
    }

    .combination {
      margin: 20px 0;
      padding: 20px;
      background: #f8fbff;
      border-radius: 10px;
      border-left: 4px solid #ba68c8;
    }

    .combination-header {
      font-weight: bold;
      color: #6a1b9a;
      margin-bottom: 10px;
      font-size: 1.1em;
    }

    .combination-items {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin: 10px 0;
    }

    .item {
      padding: 8px 15px;
      background: white;
      border-radius: 6px;
      border: 1px solid #e1f5fe;
    }

    .leftover {
      margin-top: 30px;
      padding: 20px;
      background: #eeeeff;
      border-radius: 10px;
      border-left: 4px solid #ba68c8;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      margin: 10px 0;
    }

    th,
    td {
      border: 1px solid #e0e0e0;
      padding: 12px;
      text-align: center;
    }

    th {
      background: linear-gradient(135deg, #d0a3ff, #cc9dff);
      color: white;
    }

    td:last-child {
      background: #f3e5f5;
      font-weight: bold;
    }

    .reset-btn {
      background: linear-gradient(135deg, #ef5350, #d32f2f) !important;
      width: auto !important;
      margin-top: 10px !important;
    }

    .reset-btn:hover {
      background: linear-gradient(135deg, #e53935, #c62828) !important;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>æ‹†å•è®¡ç®—å™¨</h1>

    <div class="contact-info" style="text-align: center; color: #666; margin-bottom: 20px; font-size: 0.9em;">
      é‡åˆ°äº†bugæˆ–è€…æƒ³ç»™ä¸€ç‚¹å»ºè®®ï¼Ÿ
      <br>è¯·åœ¨
      <a href="http://xhslink.com/o/2x2YmjdAGOo" target="_blank" style="color: #42a5f5; text-decoration: none;">
        å°çº¢ä¹¦å’‹è‚¥å››é¸­
      </a>è”ç³»æˆ‘ğŸ’œ
    </div>

    <div class="info-box">
      <strong>ä½¿ç”¨è¯´æ˜ï¼š</strong> å…ˆè¾“å…¥è°·å­çš„å•ä»·ï¼Œç„¶åè¾“å…¥æ¯ä¸ªä»·æ ¼çš„è°·å­éœ€è¦å¤šå°‘ä»½ã€æ¯å•å¤šå°‘é‡‘é¢ï¼Œç„¶åè®¡ç®—å™¨ä¼šç®—å‡ºæ€ä¹ˆæ‹†å•ã€‚
    </div>

    <!-- Step 1: Price List Input -->
    <div class="section-title">ç¬¬ä¸€æ­¥ï¼šè¯·è¾“å…¥è°·å­å•ä»·</div>
    <div class="input-row">
      <div class="input-group">
        <label>è°·å­å•ä»·ï¼ˆç”¨ç©ºæ ¼åˆ†å¼€ï¼‰ï¼š</label>
        <input type="text" id="priceList" class="price-list-input" placeholder="æ¯”å¦‚18 24 32 59 129" required>
      </div>
      <button type="button" onclick="setupInventoryInputs()" class="setup-btn">å¼€å§‹è¾“å…¥æ•°é‡</button>
    </div>

    <!-- Step 2: Inventory Inputs (dynamically generated) -->
    <div id="inventorySection">
      <div class="section-title">ç¬¬äºŒæ­¥ï¼šè¯·è¾“å…¥æ¯ä¸ªå•ä»·çš„æ•°é‡</div>
      <form id="inventoryForm"></form>

      <div class="parameters">
        <div class="section-title" style="color: #6a1b9a;">ç¬¬ä¸‰æ­¥ï¼šè¯·è¾“å…¥è®¡ç®—å‚æ•°</div>
        <div class="input-row">
          <div class="input-group">
            <label>æ¯å•ä»·æ ¼ï¼š</label>
            <input type="number" id="target" min="1" placeholder="æ¯”å¦‚188" required>
          </div>
          <div class="input-group">
            <label>æ¯å•å¯ä»¥è¶…å‡º</label>
            <input type="number" id="errt" value="5" min="0" required>
          </div>
        </div>
      </div>

      <button type="button" onclick="calculateCombinations()">è®¡ç®—æ‹†å•æ–¹æ¡ˆ</button>
    </div>

    <div id="errorMsg" class="error"></div>

    <!-- Results Section -->
    <div id="resultsSection">
      <h1 style="margin-top: 0;">æ‹†å•æ–¹æ¡ˆè®¡ç®—ç»“æœ</h1>

      <div class="summary" id="resultsSummary">
        <!-- Summary will be populated by JavaScript -->
      </div>

      <div class="stats" id="statsContainer">
        <!-- Stats cards will be populated by JavaScript -->
      </div>

      <div id="combinationsContainer">
        <!-- Combinations will be populated by JavaScript -->
      </div>

      <div id="leftoverContainer">
        <!-- Leftover items will be populated by JavaScript -->
      </div>

      <button type="button" onclick="resetCalculator()" class="reset-btn">é‡æ–°è®¡ç®—</button>
    </div>

  </div>

  <script>
    // Back button function removed as requested

    function setupInventoryInputs() {
      const priceListInput = document.getElementById('priceList').value;
      const errorMsg = document.getElementById('errorMsg');

      if (!priceListInput.trim()) {
        errorMsg.textContent = "è¯·è¾“å…¥ä»·æ ¼ã€‚";
        return;
      }

      // Parse prices from SPACE-separated list
      const prices = priceListInput.split(/\s+/) // Split by one or more spaces
        .map(price => parseFloat(price.trim()))
        .filter(price => !isNaN(price) && price > 0);

      if (prices.length === 0) {
        errorMsg.textContent = "è¯·è¾“å…¥å¤§äº0çš„ä»·æ ¼ã€‚";
        return;
      }

      // Check for duplicate prices
      const uniquePrices = new Set(prices);
      if (uniquePrices.size !== prices.length) {
        errorMsg.textContent = "è¯·è¾“å…¥ä¸ç›¸åŒçš„ä»·æ ¼ã€‚";
        return;
      }

      // Store prices for later use
      window.prices = prices;

      // Generate inventory input fields
      const form = document.getElementById('inventoryForm');
      form.innerHTML = ''; // Clear previous inputs

      prices.forEach((price, index) => {
        const div = document.createElement("div");
        div.classList.add("input-row");
        div.innerHTML = `
          <div class="input-group">
            <label>ä»·æ ¼ Â¥${price.toFixed(2)}: </label>
            <input type="number" id="available${index}" value="0" min="0" placeholder="æ•°é‡" required>
          </div>
        `;
        form.appendChild(div);
      });

      // Show inventory section
      document.getElementById('inventorySection').style.display = 'block';
      errorMsg.textContent = '';

      console.log("Prices set:", prices);
    }

    function dot(a, b) {
      return a.reduce((sum, val, i) => sum + val * b[i], 0);
    }

    function calculateCombinations() {
      if (!window.prices || window.prices.length === 0) {
        document.getElementById("errorMsg").textContent = "è¯·è¾“å…¥ä»·æ ¼ã€‚";
        return;
      }

      const available = [];
      for (let i = 0; i < window.prices.length; i++) {
        const a = parseInt(document.getElementById(`available${i}`).value);
        if (isNaN(a) || a < 0) {
          document.getElementById("errorMsg").textContent = "è¯·è¾“å…¥å¤§äº0çš„ä»·æ ¼ã€‚";
          return;
        }
        available.push(a);
      }

      const target = parseFloat(document.getElementById("target").value);
      const errt = parseFloat(document.getElementById("errt").value) || 0;

      if (isNaN(target) || target <= 0) {
        document.getElementById("errorMsg").textContent = "è¯·è¾“å…¥å¤§äº0çš„æ¯å•ä»·æ ¼ã€‚";
        return;
      }

      console.log("Prices:", window.prices);
      console.log("Available items:", available);
      console.log("Target:", target, "Error tolerance:", errt);

      const result = calculateCombinationSplit(window.prices, available, target, errt);

      // Display results
      displayResults(result, window.prices, target, errt, available);
    }

    function calculateCombinationSplit(prar, available_items, target, errt) {
      const totalValue = dot(available_items, prar);
      const numCombinations = Math.floor(totalValue / target);
      console.log(`Total value: ${totalValue}, Target: ${target}, Aiming for ${numCombinations} combinations`);

      const results = [];
      const remainingItems = [...available_items];

      // Try to create numCombinations valid combinations
      for (let comboIndex = 0; comboIndex < numCombinations; comboIndex++) {
        console.log(`Creating combination ${comboIndex + 1}`);
        console.log('Remaining items:', remainingItems);

        // Sort prices descending for this combination attempt to use large prices first
        const sortedIndices = prar.map((_, index) => index)
          .sort((a, b) => prar[b] - prar[a]); // Descending order

        const sortedPrar = sortedIndices.map(i => prar[i]);
        const sortedRemaining = sortedIndices.map(i => remainingItems[i]);

        const combination = findBestCombination(sortedPrar, sortedRemaining, target, errt);

        if (combination) {
          // Map back to original indices
          const originalCombination = Array(prar.length).fill(0);
          sortedIndices.forEach((origIndex, sortedIndex) => {
            originalCombination[origIndex] = combination[sortedIndex];
          });

          const combinationTotal = dot(originalCombination, prar);
          results.push({
            items: originalCombination,
            total: combinationTotal,
            difference: combinationTotal - target // Always >= 0 since below target not allowed
          });

          // Subtract used items from remaining inventory
          originalCombination.forEach((count, i) => {
            remainingItems[i] -= count;
          });
          console.log(`Found combination: ${originalCombination}, Total: ${combinationTotal}`);
        } else {
          console.log(`Could not find valid combination ${comboIndex + 1}`);
          break;
        }
      }

      // Calculate leftover items
      const leftoverValue = dot(remainingItems, prar);
      console.log(`Leftover items: ${remainingItems}, Value: ${leftoverValue}`);

      return {
        combinations: results,
        leftoverItems: remainingItems,
        leftoverValue: leftoverValue,
        totalValue: totalValue,
        targetCombinations: numCombinations,
        successRate: results.length / numCombinations
      };
    }

    function findBestCombination(prar, available_items, target, errt) {
      const combination = Array(prar.length).fill(0);
      let bestCombination = null;
      let bestDifference = Infinity;

      function backtrack(currentIndex, currentItems, currentTotal) {
        // If we've used more than available, stop
        for (let i = 0; i < currentItems.length; i++) {
          if (currentItems[i] > available_items[i]) return;
        }

        // Check if this combination is valid (MUST be >= target, can be up to target + errt)
        if (currentTotal >= target && currentTotal <= target + errt) {
          const difference = currentTotal - target; // Always >= 0

          if (difference < bestDifference) {
            bestCombination = [...currentItems];
            bestDifference = difference;
          }

          // If we found a perfect match (exactly target), stop early
          if (difference === 0) return;
        }

        // If we've exceeded target + error, stop this branch
        if (currentTotal > target + errt) return;

        // If we've used all items or reached end of prices, stop
        if (currentIndex >= prar.length) return;

        // Try quantities in descending order (use more items first for large prices)
        const maxPossible = Math.min(
          available_items[currentIndex],
          Math.floor((target + errt - currentTotal) / prar[currentIndex])
        );

        for (let qty = maxPossible; qty >= 0; qty--) {
          const newTotal = currentTotal + qty * prar[currentIndex];

          currentItems[currentIndex] = qty;
          backtrack(
            currentIndex + 1,
            currentItems,
            newTotal
          );
          currentItems[currentIndex] = 0;

          // If we found a perfect match (exactly target), break early
          if (bestDifference === 0) break;
        }
      }

      backtrack(0, combination, 0);
      return bestCombination;
    }

    function displayResults(results, prices, target, errt, originalAvailable) {
      // Update summary
      const summaryElement = document.getElementById('resultsSummary');
      if (results.combinations.length === 0) {
        summaryElement.innerHTML = 'æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„æ‹†å•æ–¹æ¡ˆã€‚';
        summaryElement.style.background = '#ffebee';
        summaryElement.style.borderLeftColor = '#e57373';
      } else {
        summaryElement.innerHTML = `æˆåŠŸæ‹†æˆ<span class="results-count">${results.combinations.length}</span>å•ï¼Œç›®æ ‡æ˜¯<span class="results-count">${results.targetCombinations}</span>å•ã€‚`;
      }

      // Create stats cards
      const statsContainer = document.getElementById('statsContainer');
      statsContainer.innerHTML = `
        <div class="stat-card success">
          <div class="stat-value">${results.combinations.length}</div>
          <div class="stat-label">å•æ•°</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${results.targetCombinations}</div>
          <div class="stat-label">ç›®æ ‡å•æ•°</div>
        </div>
        <div class="stat-card ${results.successRate >= 0.8 ? 'success' : results.successRate >= 0.5 ? 'warning' : 'danger'}">
          <div class="stat-value">${(results.successRate * 100).toFixed(1)}%</div>
          <div class="stat-label">æˆåŠŸç‡</div>
        </div>
        <div class="stat-card warning">
          <div class="stat-value">Â¥${results.leftoverValue.toFixed(2)}</div>
          <div class="stat-label">å‰©ä½™é‡‘é¢</div>
        </div>
      `;

      // Create combinations display
      const combinationsContainer = document.getElementById('combinationsContainer');
      combinationsContainer.innerHTML = '';

      if (results.combinations.length > 0) {
        combinationsContainer.innerHTML = '<h2 style="color: #1565c0; text-align: center; margin-bottom: 20px;">æ‹†å•åˆ—è¡¨</h2>';

        results.combinations.forEach((combo, index) => {
          const comboDiv = document.createElement('div');
          comboDiv.className = 'combination';
          comboDiv.innerHTML = `
            <div class="combination-header">
              ç¬¬${index + 1}å•ï¼šæ€»ä»·Â¥${combo.total.toFixed(2)} ï¼ˆè¶…å‡ºÂ¥${combo.difference.toFixed(2)}ï¼‰
            </div>
            <div class="combination-items">
              ${combo.items.map((count, i) =>
            count > 0 ? `<div class="item">${count} Ã— Â¥${prices[i]} = Â¥${(count * prices[i]).toFixed(2)}</div>` : ''
          ).join('')}
            </div>
          `;
          combinationsContainer.appendChild(comboDiv);
        });
      }

      // Create leftover display
      const leftoverContainer = document.getElementById('leftoverContainer');
      leftoverContainer.innerHTML = '';

      if (results.leftoverValue > 0) {
        leftoverContainer.className = 'leftover';
        leftoverContainer.innerHTML = `
          <h3 style="color: #6a1b9a; margin-top: 0;">å‰©ä½™é¡¹ç›®</h3>
          <p>å‰©ä½™æ€»é‡‘é¢ï¼šÂ¥${results.leftoverValue.toFixed(2)}</p>
          <table>
            <tr>
              ${prices.map(p => `<th>Â¥${p}</th>`).join('')}
              <th>æ€»é¢</th>
            </tr>
            <tr>
              ${results.leftoverItems.map(item => `<td>${item}</td>`).join('')}
              <td>Â¥${results.leftoverValue.toFixed(2)}</td>
            </tr>
          </table>
        `;
      } else {
        leftoverContainer.innerHTML = '<div class="stat-card success" style="margin-top: 20px;"><div class="stat-value">100%</div><div class="stat-label">æ‰€æœ‰é¡¹ç›®å·²ä½¿ç”¨</div></div>';
      }

      // Show results section
      document.getElementById('resultsSection').style.display = 'block';

      // Scroll to results
      document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
    }

    function resetCalculator() {
      // Reset form
      document.getElementById('priceList').value = '';
      document.getElementById('inventoryForm').innerHTML = '';
      document.getElementById('inventorySection').style.display = 'none';
      document.getElementById('resultsSection').style.display = 'none';
      document.getElementById('errorMsg').textContent = '';

      // Scroll to top
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Allow pressing Enter in the price list input to trigger setup
    document.getElementById('priceList').addEventListener('keypress', function (e) {
      if (e.key === 'Enter') {
        setupInventoryInputs();
      }
    });
  </script>
</body>

</html>