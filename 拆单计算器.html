<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ‹†å•è®¡ç®—å™¨</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <!-- Circular Home Button -->
    <a href="index.html" class="btn-home" aria-label="Home">ğŸ </a>
    
    <button class="theme-toggle" onclick="toggleTheme()" id="themeBtn">ğŸŒ™</button>

    <h1>æ‹†å•è®¡ç®—å™¨</h1>
    
    <div class="info-box">
      <div>
        <strong>ä½¿ç”¨è¯´æ˜ï¼š</strong> è¾“å…¥æ‰€æœ‰å•†å“çš„å•ä»·æ•°é‡å’Œç›®æ ‡å•ç¬”é‡‘é¢ï¼Œè®¡ç®—å™¨ä¼šå°†å•†å“æ‹†åˆ†æˆå°½å¯èƒ½å¤šçš„è®¢å•ã€‚
      </div>
    </div>

    <!-- Step 1: Items -->
    <div class="section-title">ç¬¬ä¸€æ­¥ï¼šå•†å“åº“å­˜</div>
    <div id="items-container"></div>
    <button class="btn-add" onclick="addItemRow()">+ æ·»åŠ ä¸€è¡Œå•†å“</button>

    <!-- Step 2: Parameters -->
    <div class="section-title">ç¬¬äºŒæ­¥ï¼šæ‹†å•è®¾ç½®</div>
    <div class="input-row" style="background: var(--card-bg); box-shadow: var(--shadow-card);">
      <div class="input-group">
        <label>æ¯å•ç›®æ ‡é‡‘é¢ (Â¥)</label>
        <input type="number" id="target" placeholder="ä¾‹å¦‚ 188" onchange="saveData()">
      </div>
      <div class="input-group">
        <label>å…è®¸è¶…å‡º (Â¥)</label>
        <input type="number" id="errt" value="5" onchange="saveData()">
      </div>
    </div>

    <button class="btn-primary" onclick="calculate()">å¼€å§‹æ‹†å•</button>
    <div id="errorMsg" style="display:none; margin-top:20px; padding:15px; background:var(--error-bg); color:var(--error-text); border-radius:12px; text-align:center;"></div>

    <!-- Results -->
    <div id="resultsSection" class="results-area">
      <h2>è®¡ç®—ç»“æœ</h2>
      
      <div id="combinationsContainer"></div>
      
      <div id="leftoverContainer" style="margin-top: 30px;"></div>

      <button onclick="window.scrollTo({top:0, behavior:'smooth'})" style="background:var(--input-bg); color:var(--text-color); width:100%; margin-top:30px;">â†‘ å›åˆ°é¡¶éƒ¨</button>
    </div>
  </div>

  <script>
    // --- Init ---
    document.addEventListener('DOMContentLoaded', () => {
      loadTheme();
      loadData();
    });

    function toggleTheme() {
      const html = document.documentElement;
      const next = html.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
      html.setAttribute('data-theme', next);
      localStorage.setItem('theme', next);
      document.getElementById('themeBtn').textContent = next === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
    }
    function loadTheme() {
      const saved = localStorage.getItem('theme') || 'light';
      document.documentElement.setAttribute('data-theme', saved);
      document.getElementById('themeBtn').textContent = saved === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
    }

    // --- Data Persistence ---
    function saveData() {
      const items = [];
      document.querySelectorAll('.item-row').forEach(row => {
        items.push({
          name: row.querySelector('.name-input').value,
          price: row.querySelector('.price-input').value,
          qty: row.querySelector('.qty-input').value
        });
      });
      const data = {
        items: items,
        target: document.getElementById('target').value,
        errt: document.getElementById('errt').value
      };
      localStorage.setItem('split_calc_data', JSON.stringify(data));
    }

    function loadData() {
      const saved = localStorage.getItem('split_calc_data');
      const container = document.getElementById('items-container');
      container.innerHTML = '';
      
      if (saved) {
        const data = JSON.parse(saved);
        if(data.items && data.items.length) {
          data.items.forEach(item => addItemRow(item.name, item.price, item.qty));
        } else {
          initEmptyRows();
        }
        document.getElementById('target').value = data.target || '';
        document.getElementById('errt').value = data.errt || 5;
      } else {
        initEmptyRows();
      }
    }

    function initEmptyRows() {
      addItemRow(); addItemRow();
    }

    function addItemRow(name='', price='', qty='') {
      const container = document.getElementById('items-container');
      const div = document.createElement('div');
      div.className = 'input-row item-row';
      div.innerHTML = `
        <div class="input-group" style="flex: 1.5;">
          <label>å•†å“å (é€‰å¡«)</label>
          <input type="text" class="name-input" placeholder="ä¾‹å¦‚: å§å”§" value="${name}" onchange="saveData()">
        </div>
        <div class="input-group">
          <label>å•ä»· (Â¥)</label>
          <input type="number" class="price-input" placeholder="0.00" min="0" step="0.01" value="${price}" onchange="saveData()">
        </div>
        <div class="input-group">
          <label>åº“å­˜æ•°é‡</label>
          <input type="number" class="qty-input" placeholder="0" min="0" value="${qty}" onchange="saveData()">
        </div>
        <button class="btn-remove" onclick="this.parentElement.remove(); saveData()">âœ•</button>
      `;
      container.appendChild(div);
      saveData();
    }

    // --- Algorithm: Greedy Backtracking ---
    function calculate() {
      const errorEl = document.getElementById('errorMsg');
      errorEl.style.display = 'none';

      const items = [];
      
      document.querySelectorAll('.item-row').forEach(row => {
        const n = row.querySelector('.name-input').value.trim();
        const p = parseFloat(row.querySelector('.price-input').value);
        const q = parseInt(row.querySelector('.qty-input').value);
        if(!isNaN(p) && p > 0 && !isNaN(q) && q > 0) {
          items.push({
            name: n || `Â¥${p}`,
            price: p,
            qty: q
          });
        }
      });

      const target = parseFloat(document.getElementById('target').value);
      const errt = parseFloat(document.getElementById('errt').value) || 0;

      if(items.length === 0) return showError("è¯·è¾“å…¥æœ‰æ•ˆå•†å“");
      if(isNaN(target) || target <= 0) return showError("è¯·è¾“å…¥ç›®æ ‡é‡‘é¢");

      const results = [];
      let remaining = items.map(i => i.qty);
      const prices = items.map(i => i.price);
      let hasItems = true;

      // Keep finding valid combos until we can't
      while(hasItems) {
        const combo = findCombo(prices, remaining, target, errt);
        if(combo) {
          results.push(combo);
          combo.items.forEach((count, idx) => remaining[idx] -= count);
        } else {
          hasItems = false;
        }
        if(remaining.every(c => c === 0)) hasItems = false;
      }

      displayResults(results, remaining, items);
    }

    function showError(msg) {
      const el = document.getElementById('errorMsg');
      el.textContent = msg;
      el.style.display = 'block';
    }

    function findCombo(prices, inventory, target, errt) {
      // Sort items by price descending to try expensive items first
      const indices = prices.map((_, i) => i).sort((a,b) => prices[b] - prices[a]);
      let bestCombo = null;
      let bestDiff = Infinity;

      function search(idx, currentItems, currentSum) {
        if (bestDiff === 0) return;

        if(currentSum >= target && currentSum <= target + errt) {
          if ((currentSum - target) < bestDiff) {
            bestDiff = currentSum - target;
            bestCombo = [...currentItems];
          }
          return;
        }

        if(currentSum > target + errt) return;
        if(idx >= indices.length) return;

        const pIndex = indices[idx];
        const p = prices[pIndex];
        const maxCanTake = Math.min(inventory[pIndex], Math.floor((target + errt - currentSum)/p));

        for(let q = maxCanTake; q >= 0; q--) {
          currentItems[pIndex] = q;
          search(idx + 1, currentItems, currentSum + (q * p));
          currentItems[pIndex] = 0; // Backtrack
          if(bestDiff === 0) break; 
        }
      }

      search(0, new Array(prices.length).fill(0), 0);
      
      if(bestCombo) {
        const total = bestCombo.reduce((sum, c, i) => sum + c * prices[i], 0);
        return { items: bestCombo, total: total };
      }
      return null;
    }

    function displayResults(results, leftovers, items) {
      const container = document.getElementById('combinationsContainer');
      container.innerHTML = '';
      const section = document.getElementById('resultsSection');
      section.style.display = 'block';
      
      if(results.length === 0) {
        container.innerHTML = '<div class="summary-card" style="background:var(--error-bg); color:var(--error-text);">æ— æ³•ç»„æˆä»»ä½•ç¬¦åˆæ¡ä»¶çš„è®¢å•</div>';
      } else {
        results.forEach((r, i) => {
          let itemsHtml = r.items.map((c, idx) => c > 0 ? `<span class="tag">${c} x ${items[idx].name} (Â¥${items[idx].price})</span>` : '').join('');
          
          container.innerHTML += `
            <div style="background:var(--row-bg); padding:20px; border-radius:16px; margin-bottom:15px; box-shadow:var(--shadow-card); border: 1px solid var(--input-bg);">
              <div style="font-weight:700; color:var(--primary-color); margin-bottom:10px; font-size:1.1rem;">
                ğŸ“¦ è®¢å• ${i+1} <span style="color:var(--text-color); font-weight:400; font-size:0.9rem; float:right;">æ€»ä»·: Â¥${r.total.toFixed(2)}</span>
              </div>
              <div style="display:flex; flex-wrap:wrap; gap:8px;">${itemsHtml}</div>
            </div>
          `;
        });
      }

      // Leftovers
      const leftTotal = leftovers.reduce((sum, c, i) => sum + c * items[i].price, 0);
      const leftDiv = document.getElementById('leftoverContainer');
      
      if(leftTotal > 0) {
        leftDiv.innerHTML = `
          <h3 style="margin-bottom:15px;">å‰©ä½™å•†å“ (æ€»å€¼: Â¥${leftTotal.toFixed(2)})</h3>
          <div class="table-responsive">
            <table>
              <tr>${items.map(i => `<th>${i.name}</th>`).join('')}</tr>
              <tr>${leftovers.map(c => `<td>${c}</td>`).join('')}</tr>
            </table>
          </div>
        `;
      } else {
        leftDiv.innerHTML = '<div class="summary-card" style="background:var(--success-bg); color:var(--success-text);">å®Œç¾ï¼æ‰€æœ‰å•†å“å·²åˆ†é…å®Œæ¯•ã€‚</div>';
      }
      
      const style = document.createElement('style');
      style.innerHTML = `
        .tag { display:inline-block; background:var(--input-bg); padding:6px 12px; border-radius:20px; font-size:0.9rem; color:var(--text-color); }
      `;
      document.head.appendChild(style);

      section.scrollIntoView({behavior:'smooth'});
    }
  </script>
</body>
</html>