<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>拆单计算器</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 40px;
      background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
      min-height: 100vh;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(33, 150, 243, 0.2);
      padding: 40px;
      position: relative;
      border: 1px solid #e1f5fe;
    }

    .back-btn {
      position: absolute;
      top: 20px;
      left: 20px;
      padding: 12px 20px;
      font-size: 18px;
      background: #42a5f5;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(66, 165, 245, 0.4);
      width: auto !important;
    }

    .back-btn:hover {
      background: #1e88e5;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(66, 165, 245, 0.6);
    }

    h1 {
      text-align: center;
      color: #1565c0;
      margin-bottom: 30px;
      font-size: 2.2em;
      text-shadow: 0 2px 4px rgba(21, 101, 192, 0.1);
    }

    .input-section {
      margin-bottom: 25px;
    }

    .input-row {
      margin: 15px 0;
      padding: 15px;
      background: #f8fbff;
      border-radius: 8px;
      border-left: 4px solid #42a5f5;
      transition: all 0.3s ease;
    }

    .input-row:hover {
      background: #e3f2fd;
      transform: translateX(5px);
    }

    label {
      font-weight: 600;
      color: #1976d2;
      margin-right: 10px;
    }

    input {
      padding: 10px 12px;
      margin: 0 10px;
      border: 2px solid #e1f5fe;
      border-radius: 6px;
      font-size: 14px;
      transition: all 0.3s ease;
    }

    input:focus {
      outline: none;
      border-color: #42a5f5;
      box-shadow: 0 0 0 3px rgba(66, 165, 245, 0.1);
    }

    .parameters {
      background: #f8fbff;
      padding: 20px;
      border-radius: 10px;
      margin: 25px 0;
      border-left: 4px solid #ba68c8;
    }

    .parameters label {
      color: #6a1b9a;
    }

    .parameters input {
      border-color: #e1bee7;
    }

    .parameters input:focus {
      border-color: #ba68c8;
      box-shadow: 0 0 0 3px rgba(186, 104, 200, 0.1);
    }

    button {
      padding: 15px 30px;
      font-size: 18px;
      margin-top: 20px;
      background: linear-gradient(135deg, #42a5f5, #1976d2);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(66, 165, 245, 0.4);
      font-weight: 600;
      width: 100%;
    }

    button:hover {
      background: linear-gradient(135deg, #1e88e5, #1565c0);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(66, 165, 245, 0.6);
    }

    .error {
      color: #d32f2f;
      font-weight: bold;
      margin-top: 15px;
      padding: 15px;
      background: #ffebee;
      border-radius: 8px;
      border-left: 4px solid #f44336;
      text-align: center;
    }

    .input-group {
      display: inline-block;
      margin: 0 15px;
    }

    .section-title {
      color: #1565c0;
      font-size: 1.1em;
      font-weight: 600;
      margin-bottom: 15px;
      padding-bottom: 5px;
      border-bottom: 2px solid #e3f2fd;
    }

    .info-box {
      background: #e8f5e9;
      border-left: 4px solid #66bb6a;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      color: #2e7d32;
    }

    .price-list-input {
      width: 300px;
      padding: 12px;
      font-size: 16px;
    }

    .price-list-example {
      color: #666;
      font-size: 0.9em;
      margin-top: 5px;
      font-style: italic;
    }

    #inventorySection {
      display: none;
    }

    .setup-btn {
      width: auto !important;
      margin-top: 0 !important;
    }
  </style>
</head>

<body>
  <div class="container">
    <button class="back-btn" onclick="goBack()">⬅ 返回</button>

    <h1>拆单计算器</h1>

    <div class="info-box">
      <strong>使用说明：</strong> 先输入谷子的单价，然后输入每个价格的谷子需要多少份、每单多少金额，然后计算器会算出怎么拆单。
    </div>

    <!-- Step 1: Price List Input -->
    <div class="section-title">第一步：请输入谷子单价</div>
    <div class="input-row">
      <div class="input-group">
        <label>谷子单价（用空格分开）：</label>
        <input type="text" id="priceList" class="price-list-input" placeholder="比如18 24 32 59 129" required>
        <!-- <div class="price-list-example">Enter prices separated by spaces (e.g., 1.5 2 3.25 4.75)</div> -->
      </div>
      <button type="button" onclick="setupInventoryInputs()" class="setup-btn">开始输入数量</button>
    </div>

    <!-- Step 2: Inventory Inputs (dynamically generated) -->
    <div id="inventorySection">
      <div class="section-title">第二步：请输入每个单价的数量</div>
      <form id="inventoryForm"></form>

      <div class="parameters">
        <div class="section-title" style="color: #6a1b9a;">第三步：请输入计算参数</div>
        <div class="input-row">
          <div class="input-group">
            <label>每单价格：</label>
            <input type="number" id="target" min="1" placeholder="比如188" required>
          </div>
          <div class="input-group">
            <label>每单可以超出</label>
            <input type="number" id="errt" value="5" min="0" required>
          </div>
        </div>
      </div>

      <button type="button" onclick="calculateCombinations()">计算拆单方案</button>
    </div>

    <div id="errorMsg" class="error"></div>
  </div>

  <script>
    // Back button function
    function goBack() {
      window.location.href = "index.html"; // Change this to your main page filename
    }

    function setupInventoryInputs() {
      const priceListInput = document.getElementById('priceList').value;
      const errorMsg = document.getElementById('errorMsg');

      if (!priceListInput.trim()) {
        errorMsg.textContent = "请输入价格。";
        return;
      }

      // Parse prices from SPACE-separated list
      const prices = priceListInput.split(/\s+/) // Split by one or more spaces
        .map(price => parseFloat(price.trim()))
        .filter(price => !isNaN(price) && price > 0);

      if (prices.length === 0) {
        errorMsg.textContent = "请输入大于0的价格。";
        return;
      }

      // Check for duplicate prices
      const uniquePrices = new Set(prices);
      if (uniquePrices.size !== prices.length) {
        errorMsg.textContent = "请输入不相同的价格。";
        return;
      }

      // Store prices for later use
      window.prices = prices;

      // Generate inventory input fields
      const form = document.getElementById('inventoryForm');
      form.innerHTML = ''; // Clear previous inputs

      prices.forEach((price, index) => {
        const div = document.createElement("div");
        div.classList.add("input-row");
        div.innerHTML = `
          <div class="input-group">
            <label>价格 ¥${price.toFixed(2)}: </label>
            <input type="number" id="available${index}" value="0" min="0" placeholder="数量" required>
          </div>
        `;
        form.appendChild(div);
      });

      // Show inventory section
      document.getElementById('inventorySection').style.display = 'block';
      errorMsg.textContent = '';

      console.log("Prices set:", prices);
    }

    function dot(a, b) {
      return a.reduce((sum, val, i) => sum + val * b[i], 0);
    }

    function calculateCombinations() {
      if (!window.prices || window.prices.length === 0) {
        document.getElementById("errorMsg").textContent = "请输入价格。";
        return;
      }

      const available = [];
      for (let i = 0; i < window.prices.length; i++) {
        const a = parseInt(document.getElementById(`available${i}`).value);
        if (isNaN(a) || a < 0) {
          document.getElementById("errorMsg").textContent = "请输入大于0的价格。";
          return;
        }
        available.push(a);
      }

      const target = parseFloat(document.getElementById("target").value);
      const errt = parseFloat(document.getElementById("errt").value) || 0;

      if (isNaN(target) || target <= 0) {
        document.getElementById("errorMsg").textContent = "请输入大于0的每单价格。";
        return;
      }

      console.log("Prices:", window.prices);
      console.log("Available items:", available);
      console.log("Target:", target, "Error tolerance:", errt);

      const result = calculateCombinationSplit(window.prices, available, target, errt);

      // Store results for display
      localStorage.setItem("combinationResults", JSON.stringify(result));
      localStorage.setItem("prices", JSON.stringify(window.prices));
      localStorage.setItem("target", target);
      localStorage.setItem("errt", errt);
      localStorage.setItem("originalAvailable", JSON.stringify(available));

      window.location.href = "combination-results.html";
    }

    function calculateCombinationSplit(prar, available_items, target, errt) {
      const totalValue = dot(available_items, prar);
      const numCombinations = Math.floor(totalValue / target);
      console.log(`Total value: ${totalValue}, Target: ${target}, Aiming for ${numCombinations} combinations`);

      const results = [];
      const remainingItems = [...available_items];

      // Try to create numCombinations valid combinations
      for (let comboIndex = 0; comboIndex < numCombinations; comboIndex++) {
        console.log(`Creating combination ${comboIndex + 1}`);
        console.log('Remaining items:', remainingItems);

        // Sort prices descending for this combination attempt to use large prices first
        const sortedIndices = prar.map((_, index) => index)
          .sort((a, b) => prar[b] - prar[a]); // Descending order

        const sortedPrar = sortedIndices.map(i => prar[i]);
        const sortedRemaining = sortedIndices.map(i => remainingItems[i]);

        const combination = findBestCombination(sortedPrar, sortedRemaining, target, errt);

        if (combination) {
          // Map back to original indices
          const originalCombination = Array(prar.length).fill(0);
          sortedIndices.forEach((origIndex, sortedIndex) => {
            originalCombination[origIndex] = combination[sortedIndex];
          });

          const combinationTotal = dot(originalCombination, prar);
          results.push({
            items: originalCombination,
            total: combinationTotal,
            difference: combinationTotal - target // Always >= 0 since below target not allowed
          });

          // Subtract used items from remaining inventory
          originalCombination.forEach((count, i) => {
            remainingItems[i] -= count;
          });
          console.log(`Found combination: ${originalCombination}, Total: ${combinationTotal}`);
        } else {
          console.log(`Could not find valid combination ${comboIndex + 1}`);
          break;
        }
      }

      // Calculate leftover items
      const leftoverValue = dot(remainingItems, prar);
      console.log(`Leftover items: ${remainingItems}, Value: ${leftoverValue}`);

      return {
        combinations: results,
        leftoverItems: remainingItems,
        leftoverValue: leftoverValue,
        totalValue: totalValue,
        targetCombinations: numCombinations,
        successRate: results.length / numCombinations
      };
    }

    function findBestCombination(prar, available_items, target, errt) {
      const combination = Array(prar.length).fill(0);
      let bestCombination = null;
      let bestDifference = Infinity;

      function backtrack(currentIndex, currentItems, currentTotal) {
        // If we've used more than available, stop
        for (let i = 0; i < currentItems.length; i++) {
          if (currentItems[i] > available_items[i]) return;
        }

        // Check if this combination is valid (MUST be >= target, can be up to target + errt)
        if (currentTotal >= target && currentTotal <= target + errt) {
          const difference = currentTotal - target; // Always >= 0

          if (difference < bestDifference) {
            bestCombination = [...currentItems];
            bestDifference = difference;
          }

          // If we found a perfect match (exactly target), stop early
          if (difference === 0) return;
        }

        // If we've exceeded target + error, stop this branch
        if (currentTotal > target + errt) return;

        // If we've used all items or reached end of prices, stop
        if (currentIndex >= prar.length) return;

        // Try quantities in descending order (use more items first for large prices)
        const maxPossible = Math.min(
          available_items[currentIndex],
          Math.floor((target + errt - currentTotal) / prar[currentIndex])
        );

        for (let qty = maxPossible; qty >= 0; qty--) {
          const newTotal = currentTotal + qty * prar[currentIndex];

          currentItems[currentIndex] = qty;
          backtrack(
            currentIndex + 1,
            currentItems,
            newTotal
          );
          currentItems[currentIndex] = 0;

          // If we found a perfect match (exactly target), break early
          if (bestDifference === 0) break;
        }
      }

      backtrack(0, combination, 0);
      return bestCombination;
    }

    // Allow pressing Enter in the price list input to trigger setup
    document.getElementById('priceList').addEventListener('keypress', function (e) {
      if (e.key === 'Enter') {
        setupInventoryInputs();
      }
    });
  </script>
</body>

</html>